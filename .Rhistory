ids <- trimws(as.character(x))
ids <- basename(ids)
ids <- sub("\\.raw\\.PG\\.Quantity$", "", ids, ignore.case = TRUE)
ids <- sub("\\.raw$", "", ids, ignore.case = TRUE)
ids <- sub("\\.[^.]+$", "", ids)
ids
}
model_runs <- as.integer(Sys.getenv("ADAPTMS_N_RUNS", "10"))
data_path <- file.path(here::here(), "data")
# Training: Sweden + MagKiel combined
df_train <- read.delim(
file.path(data_path, "AD_CSF_Sweden+MagKiel.pg_matrix.tsv"),
sep = "\t", check.names = FALSE
)
gene_dict <- setNames(df_train$Genes, df_train$Protein.Group)
prot_train <- df_train[, -(1:5), drop = FALSE]
rownames(prot_train) <- sanitize_row_ids(df_train$Protein.Group, prefix = "protein_group")
prot_train <- as.data.frame(t(prot_train))
rownames(prot_train) <- sanitize_row_ids(
normalize_sample_ids(rownames(prot_train)),
prefix = "sample"
)
prot_train[prot_train == 0] <- NA
prot_train <- log10(prot_train)
cat("Training samples:", nrow(prot_train), "\n")
df_val <- read.delim(
file.path(data_path, "AD_CSF_Berlin_Sw+MK_speclib.tsv"),
sep = "\t", check.names = FALSE
)
prot_val <- df_val[, -(1:5), drop = FALSE]
rownames(prot_val) <- sanitize_row_ids(df_val$Protein.Group, prefix = "protein_group")
prot_val <- as.data.frame(t(prot_val))
rownames(prot_val) <- sanitize_row_ids(
normalize_sample_ids(rownames(prot_val)),
prefix = "sample"
)
prot_val[prot_val == 0] <- NA
prot_val <- log10(prot_val)
cat("Validation samples:", nrow(prot_val), "\n")
d_groups <- as.data.frame(
read_excel(file.path(data_path, "annotation of samples_AM1.5.11.xlsx"))
)
rownames(d_groups) <- sanitize_row_ids(
normalize_sample_ids(d_groups$`sample name`),
prefix = "sample_name"
)
cat_all <- d_groups[, "biochemical AD classification", drop = FALSE]
cat_train <- cat_all[intersect(rownames(prot_train), rownames(cat_all)), , drop = FALSE]
cat_val   <- cat_all[intersect(rownames(prot_val), rownames(cat_all)), , drop = FALSE]
cat("Training metadata-matched samples:", nrow(cat_train), "\n")
cat("Validation metadata-matched samples:", nrow(cat_val), "\n")
shared_prots <- intersect(colnames(prot_train), colnames(prot_val))
prot_train <- prot_train[, shared_prots, drop = FALSE]
prot_val   <- prot_val[, shared_prots, drop = FALSE]
cat("Shared proteins:", length(shared_prots), "\n")
baseline <- BaselineClassifier$new(
prot_df = prot_train,
cat_df  = cat_train,
between = "biochemical AD classification"
)
baseline$classify_and_plot(
category1 = "biochemical control",
category2 = "biochemical AD",
n_runs = model_runs
)
baseline$validate_and_plot(
validation_prot_df = prot_val,
validation_cat_df  = cat_val,
category1 = "biochemical control",
category2 = "biochemical AD"
)
baseline$save_plots_to_pdf(file.path(data_path, "AD_CSF_SwKiel_to_Berlin_Baseline_R.pdf"))
nonrefit <- NonRefitClassifier$new(
prot_df   = prot_train,
cat_df    = cat_train,
gene_dict = gene_dict,
between   = "biochemical AD classification"
)
nonrefit$classify_and_plot(
category1 = "biochemical control",
category2 = "biochemical AD",
n_runs = model_runs
)
nonrefit$validate_and_plot(
validation_prot_df = prot_val,
validation_cat_df  = cat_val,
category1 = "biochemical control",
category2 = "biochemical AD"
)
nonrefit$save_plots_to_pdf(file.path(data_path, "AD_CSF_SwKiel_to_Berlin_NonRefit_R.pdf"))
adaptms_folder <- AdaptmsClassifierFolder$new(
prot_df   = prot_train,
cat_df    = cat_train,
gene_dict = gene_dict,
between   = "biochemical AD classification"
)
adaptms_folder$classify_and_plot(
category1 = "biochemical control",
category2 = "biochemical AD",
n_runs = model_runs,
topn_features = 50
)
sf_dir <- file.path(data_path, "Single_file_results", "Train_sweden+MagKiel_apply_to_Berlin")
if (dir.exists(sf_dir)) {
# Prepare metadata for single-file samples
cat_sf <- cat_all
adaptms_folder$classify_directory(
directory = sf_dir,
cat_validation_pool_SF = cat_sf,
category1 = "biochemical control",
category2 = "biochemical AD"
)
adaptms_folder$plot_accumulated_roc(
category1 = "biochemical control",
category2 = "biochemical AD"
)
adaptms_folder$save_plots_to_pdf(
file.path(data_path, "AD_CSF_SwKiel_to_Berlin_ADAPTMS_Folder_R.pdf")
)
} else {
cat("Single-file results directory not found. Skipping folder-based validation.\n")
}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
fig.width = 8, fig.height = 6)
library(readxl)
library(ggplot2)
# Source classifier modules
source(file.path(here::here(), "R", "AdaptmsClassifier.R"))
source(file.path(here::here(), "R", "BaselineClassifier.R"))
source(file.path(here::here(), "R", "NonRefitClassifier.R"))
sanitize_row_ids <- function(x, prefix = "row") {
ids <- trimws(as.character(x))
missing <- is.na(ids) | ids == ""
if (any(missing)) {
ids[missing] <- paste0(prefix, "_", seq_len(sum(missing)))
}
make.unique(ids)
}
normalize_sample_ids <- function(x) {
ids <- trimws(as.character(x))
ids <- basename(ids)
ids <- sub("\\.raw\\.PG\\.Quantity$", "", ids, ignore.case = TRUE)
ids <- sub("\\.raw$", "", ids, ignore.case = TRUE)
ids <- sub("\\.[^.]+$", "", ids)
ids
}
model_runs <- as.integer(Sys.getenv("ADAPTMS_N_RUNS", "10"))
data_path <- file.path(here::here(), "data")
# Training: Sweden + MagKiel combined
df_train <- read.delim(
file.path(data_path, "AD_CSF_Sweden+MagKiel.pg_matrix.tsv"),
sep = "\t", check.names = FALSE
)
gene_dict <- setNames(df_train$Genes, df_train$Protein.Group)
prot_train <- df_train[, -(1:5), drop = FALSE]
rownames(prot_train) <- sanitize_row_ids(df_train$Protein.Group, prefix = "protein_group")
prot_train <- as.data.frame(t(prot_train))
rownames(prot_train) <- sanitize_row_ids(
normalize_sample_ids(rownames(prot_train)),
prefix = "sample"
)
prot_train[prot_train == 0] <- NA
prot_train <- log10(prot_train)
cat("Training samples:", nrow(prot_train), "\n")
df_val <- read.delim(
file.path(data_path, "AD_CSF_Berlin_Sw+MK_speclib.tsv"),
sep = "\t", check.names = FALSE
)
prot_val <- df_val[, -(1:5), drop = FALSE]
rownames(prot_val) <- sanitize_row_ids(df_val$Protein.Group, prefix = "protein_group")
prot_val <- as.data.frame(t(prot_val))
rownames(prot_val) <- sanitize_row_ids(
normalize_sample_ids(rownames(prot_val)),
prefix = "sample"
)
prot_val[prot_val == 0] <- NA
prot_val <- log10(prot_val)
cat("Validation samples:", nrow(prot_val), "\n")
d_groups <- as.data.frame(
read_excel(file.path(data_path, "annotation of samples_AM1.5.11.xlsx"))
)
rownames(d_groups) <- sanitize_row_ids(
normalize_sample_ids(d_groups$`sample name`),
prefix = "sample_name"
)
cat_all <- d_groups[, "biochemical AD classification", drop = FALSE]
cat_train <- cat_all[intersect(rownames(prot_train), rownames(cat_all)), , drop = FALSE]
cat_val   <- cat_all[intersect(rownames(prot_val), rownames(cat_all)), , drop = FALSE]
cat("Training metadata-matched samples:", nrow(cat_train), "\n")
cat("Validation metadata-matched samples:", nrow(cat_val), "\n")
shared_prots <- intersect(colnames(prot_train), colnames(prot_val))
prot_train <- prot_train[, shared_prots, drop = FALSE]
prot_val   <- prot_val[, shared_prots, drop = FALSE]
cat("Shared proteins:", length(shared_prots), "\n")
baseline <- BaselineClassifier$new(
prot_df = prot_train,
cat_df  = cat_train,
between = "biochemical AD classification"
)
baseline$classify_and_plot(
category1 = "biochemical control",
category2 = "biochemical AD",
n_runs = model_runs
)
baseline$validate_and_plot(
validation_prot_df = prot_val,
validation_cat_df  = cat_val,
category1 = "biochemical control",
category2 = "biochemical AD"
)
baseline$save_plots_to_pdf(file.path(data_path, "AD_CSF_SwKiel_to_Berlin_Baseline_R.pdf"))
nonrefit <- NonRefitClassifier$new(
prot_df   = prot_train,
cat_df    = cat_train,
gene_dict = gene_dict,
between   = "biochemical AD classification"
)
nonrefit$classify_and_plot(
category1 = "biochemical control",
category2 = "biochemical AD",
n_runs = model_runs
)
nonrefit$validate_and_plot(
validation_prot_df = prot_val,
validation_cat_df  = cat_val,
category1 = "biochemical control",
category2 = "biochemical AD"
)
nonrefit$save_plots_to_pdf(file.path(data_path, "AD_CSF_SwKiel_to_Berlin_NonRefit_R.pdf"))
adaptms_folder <- AdaptmsClassifierFolder$new(
prot_df   = prot_train,
cat_df    = cat_train,
gene_dict = gene_dict,
between   = "biochemical AD classification"
)
adaptms_folder$classify_and_plot(
category1 = "biochemical control",
category2 = "biochemical AD",
n_runs = model_runs,
topn_features = 50
)
sf_dir <- file.path(data_path, "Single_file_results", "Train_sweden+MagKiel_apply_to_Berlin")
if (dir.exists(sf_dir)) {
# Prepare metadata for single-file samples
cat_sf <- cat_all
adaptms_folder$classify_directory(
directory = sf_dir,
cat_validation_pool_SF = cat_sf,
category1 = "biochemical control",
category2 = "biochemical AD"
)
adaptms_folder$plot_accumulated_roc(
category1 = "biochemical control",
category2 = "biochemical AD"
)
adaptms_folder$save_plots_to_pdf(
file.path(data_path, "AD_CSF_SwKiel_to_Berlin_ADAPTMS_Folder_R.pdf")
)
} else {
cat("Single-file results directory not found. Skipping folder-based validation.\n")
}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
fig.width = 8, fig.height = 6)
library(readxl)
library(ggplot2)
library(VIM)
# Source classifier modules
source(file.path(here::here(), "R", "AdaptmsClassifier.R"))
source(file.path(here::here(), "R", "BaselineClassifier.R"))
source(file.path(here::here(), "R", "NonValClassifier.R"))
sanitize_row_ids <- function(x, prefix = "row") {
ids <- trimws(as.character(x))
missing <- is.na(ids) | ids == ""
if (any(missing)) {
ids[missing] <- paste0(prefix, "_", seq_len(sum(missing)))
}
make.unique(ids)
}
normalize_sample_ids <- function(x) {
ids <- trimws(as.character(x))
ids <- basename(ids)
ids <- sub("\\.raw\\.PG\\.Quantity$", "", ids, ignore.case = TRUE)
ids <- sub("\\.raw$", "", ids, ignore.case = TRUE)
ids <- sub("\\.[^.]+$", "", ids)
ids
}
model_runs <- as.integer(Sys.getenv("ADAPTMS_N_RUNS", "10"))
data_path <- file.path(here::here(), "data")
# Load DIA-NN pg_matrix TSV
df <- read.delim(file.path(data_path, "AD_CSF_full_study.pg_matrix.tsv"),
sep = "\t", check.names = FALSE)
cat("Protein groups:", nrow(df), "\n")
cat("Total columns:", ncol(df), "\n")
# Create gene dictionary
gene_dict <- setNames(df$Genes, df$Protein.Group)
# Extract protein intensity matrix (skip first 5 metadata columns)
prot <- df[, -(1:5), drop = FALSE]
rownames(prot) <- sanitize_row_ids(df$Protein.Group, prefix = "protein_group")
# Transpose: samples as rows, proteins as columns
prot <- as.data.frame(t(prot))
# Clean sample names
rownames(prot) <- sanitize_row_ids(
normalize_sample_ids(rownames(prot)),
prefix = "sample"
)
# Log10 transform, replacing 0 with NA
prot[prot == 0] <- NA
prot <- log10(prot)
cat("Samples:", nrow(prot), "\n")
cat("Proteins:", ncol(prot), "\n")
d_groups <- as.data.frame(
read_excel(file.path(data_path, "annotation of samples_AM1.5.11.xlsx"))
)
rownames(d_groups) <- sanitize_row_ids(
normalize_sample_ids(d_groups$`sample name`),
prefix = "sample_name"
)
cat <- d_groups[, "biochemical AD classification", drop = FALSE]
cat("Metadata samples:", nrow(cat), "\n")
cat("Classes:", paste(sort(unique(cat[[1]])), collapse = ", "), "\n")
# Impute for PCA visualization
prot_for_pca <- prot[rownames(prot) %in% rownames(d_groups), , drop = FALSE]
all_na_cols <- vapply(prot_for_pca, function(x) all(is.na(x)), logical(1))
prot_for_pca <- prot_for_pca[, !all_na_cols, drop = FALSE]
if (nrow(prot_for_pca) < 2 || ncol(prot_for_pca) < 2) {
stop("Not enough matched, non-empty data for PCA after metadata alignment.")
}
prot_imputed <- as.data.frame(kNN(prot_for_pca, k = 5, imp_var = FALSE))
rownames(prot_imputed) <- rownames(prot_for_pca)
non_constant_cols <- vapply(
prot_imputed,
function(x) {
x <- x[is.finite(x)]
length(x) > 1 && sd(x) > 0
},
logical(1)
)
prot_for_pca_model <- prot_imputed[, non_constant_cols, drop = FALSE]
if (ncol(prot_for_pca_model) < 2) {
stop("Not enough variable protein features remain for PCA.")
}
pca <- prcomp(prot_for_pca_model, center = TRUE, scale. = TRUE)
pca_df <- data.frame(
PC1 = pca$x[, 1],
PC2 = pca$x[, 2],
site = d_groups[rownames(prot_imputed), "collection site"]
)
var_explained <- summary(pca)$importance[2, 1:2] * 100
ggplot(pca_df, aes(x = PC1, y = PC2, color = site)) +
geom_point(size = 2, alpha = 0.7) +
labs(
x = sprintf("PC1 (%.1f%%)", var_explained[1]),
y = sprintf("PC2 (%.1f%%)", var_explained[2]),
title = "PCA of AD CSF Full Cohort",
color = "Collection Site"
) +
theme_minimal()
baseline <- BaselineClassifier$new(
prot_df = prot,
cat_df  = cat,
between = "biochemical AD classification"
)
baseline$classify_and_plot(
category1 = "biochemical control",
category2 = "biochemical AD",
n_runs = model_runs
)
baseline$save_plots_to_pdf(file.path(data_path, "AD_CSF_Baseline_R.pdf"))
nonval <- NonValClassifier$new(
prot_df = prot,
cat_df  = cat,
between = "biochemical AD classification"
)
result <- nonval$classify_and_plot_multiple(
category1 = "biochemical control",
category2 = "biochemical AD",
num_repeats = model_runs
)
cat(sprintf("Mean AUC: %.2f (95%% CI: %.2f - %.2f)\n",
result$mean_auc, result$ci[1], result$ci[2]))
nonval$save_plots_to_pdf(file.path(data_path, "AD_CSF_NonVal_R.pdf"))
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
fig.width = 8, fig.height = 6)
library(readxl)
library(ggplot2)
library(caret)
library(VIM)
# Source classifier modules
source(file.path(here::here(), "R", "AdaptmsClassifier.R"))
source(file.path(here::here(), "R", "BaselineClassifier.R"))
source(file.path(here::here(), "R", "XGBfillClassifier.R"))
source(file.path(here::here(), "R", "AdaptmsMultiClassifier.R"))
sanitize_row_ids <- function(x, prefix = "row") {
ids <- trimws(as.character(x))
missing <- is.na(ids) | ids == ""
if (any(missing)) {
ids[missing] <- paste0(prefix, "_", seq_len(sum(missing)))
}
make.unique(ids)
}
model_runs <- as.integer(Sys.getenv("ADAPTMS_N_RUNS", "10"))
data_path <- file.path(here::here(), "data")
# Load razor intensities
df <- read.delim(file.path(data_path, "razor_intensities.tsv"),
sep = "\t", check.names = FALSE)
# Load sample metadata
d_cat <- as.data.frame(read_excel(file.path(data_path, "sample_info_2575processed_PRIDE.xlsx")))
cat("Protein groups:", nrow(df), "\n")
cat("Total columns:", ncol(df), "\n")
cat("Metadata samples:", nrow(d_cat), "\n")
# Extract protein columns (skip metadata columns)
# The raw file uses "Protein Group"/"Gene Names" and "<Injection> Razor Intensity" columns.
protein_group_col <- if ("Protein.Group" %in% colnames(df)) "Protein.Group" else "Protein Group"
gene_names_col <- if ("Genes" %in% colnames(df)) "Genes" else "Gene Names"
intensity_cols <- grep("Razor Intensity$", colnames(df), value = TRUE)
if (!protein_group_col %in% colnames(df) || !gene_names_col %in% colnames(df)) {
stop("Expected protein group and gene name columns were not found in razor_intensities.tsv.")
}
if (length(intensity_cols) == 0) {
stop("No '*Razor Intensity' columns found in razor_intensities.tsv.")
}
gene_dict <- setNames(df[[gene_names_col]], df[[protein_group_col]])
prot <- df[, intensity_cols, drop = FALSE]
rownames(prot) <- sanitize_row_ids(df[[protein_group_col]], prefix = "protein_group")
prot <- as.data.frame(t(prot))
# Clean sample names from "<Injection> Razor Intensity"
rownames(prot) <- sanitize_row_ids(
sub(" Razor Intensity$", "", rownames(prot)),
prefix = "sample"
)
# Ensure numeric columns before transformation
prot[] <- lapply(prot, function(col) suppressWarnings(as.numeric(col)))
# Log10 transform, zeros become NA
prot[prot == 0] <- NA
prot <- log10(prot)
# Set up metadata with matching row names
rownames(d_cat) <- sanitize_row_ids(as.character(d_cat$Injection), prefix = "injection")
cat("Processed samples:", nrow(prot), "\n")
cat("Processed proteins:", ncol(prot), "\n")
# Discovery cohorts
disc_groups <- c("GAinS_disc")
disc_samples <- rownames(d_cat)[d_cat$Group %in% disc_groups]
disc_samples <- intersect(disc_samples, rownames(prot))
# Validation cohorts
val_groups <- c("GAinS_vali")
val_samples <- rownames(d_cat)[d_cat$Group %in% val_groups]
val_samples <- intersect(val_samples, rownames(prot))
prot_disc <- prot[disc_samples, , drop = FALSE]
cat_disc  <- d_cat[disc_samples, "SRS", drop = FALSE]
prot_val <- prot[val_samples, , drop = FALSE]
cat_val  <- d_cat[val_samples, "SRS", drop = FALSE]
cat("Discovery samples:", nrow(prot_disc), "\n")
cat("Validation samples:", nrow(prot_val), "\n")
baseline <- BaselineClassifier$new(
prot_df = prot_disc,
cat_df  = cat_disc,
between = "SRS"
)
baseline$classify_and_plot(
category1 = "SRS1",
category2 = "non-SRS1",
n_runs = model_runs
)
baseline$validate_and_plot(
validation_prot_df = prot_val,
validation_cat_df  = cat_val,
category1 = "SRS1",
category2 = "non-SRS1"
)
baseline$save_plots_to_pdf(file.path(data_path, "Sepsis_Baseline_R.pdf"))
adaptms <- AdaptmsClassifierDF$new(
prot_df   = prot_disc,
cat_df    = cat_disc,
gene_dict = gene_dict,
between   = "SRS"
)
adaptms$classify_and_plot(
category1 = "SRS1",
category2 = "non-SRS1",
n_runs = model_runs,
topn_features = 50
)
adaptms$classify_dataframe(
validation_df     = prot_val,
validation_cat_df = cat_val
)
adaptms$plot_validation_roc(
category1 = "SRS1",
category2 = "non-SRS1"
)
adaptms$save_plots_to_pdf(file.path(data_path, "Sepsis_ADAPTMS_R.pdf"))
xgbfill <- XGBRFClassifierDF$new(
prot_df   = prot_disc,
cat_df    = cat_disc,
gene_dict = gene_dict,
between   = "SRS"
)
xgbfill$classify_and_plot(
category1 = "SRS1",
category2 = "non-SRS1",
n_runs = model_runs
)
xgbfill$classify_dataframe(
validation_df     = prot_val,
validation_cat_df = cat_val,
fill_na_strategy  = "zero"
)
xgbfill$plot_validation_roc(
category1 = "SRS1",
category2 = "non-SRS1"
)
xgbfill$save_plots_to_pdf(file.path(data_path, "Sepsis_XGBfill_R.pdf"))
