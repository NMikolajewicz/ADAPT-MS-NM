---
title: "ADAPT-MS: Sepsis Dataset Study"
author: "ADAPT-MS Pipeline (R)"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.width = 8, fig.height = 6)
```

# 1. Load Dependencies and Classifiers

```{r load_libraries}
library(readxl)
library(ggplot2)
library(caret)
library(VIM)

# Source classifier modules
source(file.path(here::here(), "R", "AdaptmsClassifier.R"))
source(file.path(here::here(), "R", "BaselineClassifier.R"))
source(file.path(here::here(), "R", "XGBfillClassifier.R"))
source(file.path(here::here(), "R", "AdaptmsMultiClassifier.R"))

sanitize_row_ids <- function(x, prefix = "row") {
  ids <- trimws(as.character(x))
  missing <- is.na(ids) | ids == ""
  if (any(missing)) {
    ids[missing] <- paste0(prefix, "_", seq_len(sum(missing)))
  }
  make.unique(ids)
}

model_runs <- as.integer(Sys.getenv("ADAPTMS_N_RUNS", "10"))
```

# 2. Load Sepsis Proteomics Data

```{r load_data}
data_path <- file.path(here::here(), "data")

# Load razor intensities
df <- read.delim(file.path(data_path, "razor_intensities.tsv"),
                 sep = "\t", check.names = FALSE)

# Load sample metadata
d_cat <- as.data.frame(read_excel(file.path(data_path, "sample_info_2575processed_PRIDE.xlsx")))

cat("Protein groups:", nrow(df), "\n")
cat("Total columns:", ncol(df), "\n")
cat("Metadata samples:", nrow(d_cat), "\n")
```

# 3. Data Preprocessing

```{r preprocess}
# Extract protein columns (skip metadata columns)
# The raw file uses "Protein Group"/"Gene Names" and "<Injection> Razor Intensity" columns.
protein_group_col <- if ("Protein.Group" %in% colnames(df)) "Protein.Group" else "Protein Group"
gene_names_col <- if ("Genes" %in% colnames(df)) "Genes" else "Gene Names"
intensity_cols <- grep("Razor Intensity$", colnames(df), value = TRUE)

if (!protein_group_col %in% colnames(df) || !gene_names_col %in% colnames(df)) {
  stop("Expected protein group and gene name columns were not found in razor_intensities.tsv.")
}
if (length(intensity_cols) == 0) {
  stop("No '*Razor Intensity' columns found in razor_intensities.tsv.")
}

gene_dict <- setNames(df[[gene_names_col]], df[[protein_group_col]])

prot <- df[, intensity_cols, drop = FALSE]
rownames(prot) <- sanitize_row_ids(df[[protein_group_col]], prefix = "protein_group")
prot <- as.data.frame(t(prot))

# Clean sample names from "<Injection> Razor Intensity"
rownames(prot) <- sanitize_row_ids(
  sub(" Razor Intensity$", "", rownames(prot)),
  prefix = "sample"
)

# Ensure numeric columns before transformation
prot[] <- lapply(prot, function(col) suppressWarnings(as.numeric(col)))

# Log10 transform, zeros become NA
prot[prot == 0] <- NA
prot <- log10(prot)

# Set up metadata with matching row names
rownames(d_cat) <- sanitize_row_ids(as.character(d_cat$Injection), prefix = "injection")

cat("Processed samples:", nrow(prot), "\n")
cat("Processed proteins:", ncol(prot), "\n")
```

# 4. Define Discovery and Validation Cohorts

```{r define_cohorts}
# Discovery cohorts
disc_groups <- c("GAinS_disc")
disc_samples <- rownames(d_cat)[d_cat$Group %in% disc_groups]
disc_samples <- intersect(disc_samples, rownames(prot))

# Validation cohorts
val_groups <- c("GAinS_vali")
val_samples <- rownames(d_cat)[d_cat$Group %in% val_groups]
val_samples <- intersect(val_samples, rownames(prot))

prot_disc <- prot[disc_samples, , drop = FALSE]
cat_disc  <- d_cat[disc_samples, "SRS", drop = FALSE]

prot_val <- prot[val_samples, , drop = FALSE]
cat_val  <- d_cat[val_samples, "SRS", drop = FALSE]

cat("Discovery samples:", nrow(prot_disc), "\n")
cat("Validation samples:", nrow(prot_val), "\n")
```

# 5. Baseline Classifier

```{r baseline}
baseline <- BaselineClassifier$new(
  prot_df = prot_disc,
  cat_df  = cat_disc,
  between = "SRS"
)

baseline$classify_and_plot(
  category1 = "SRS1",
  category2 = "non-SRS1",
  n_runs = model_runs
)
```

## 5.1 Baseline Validation

```{r baseline_val}
baseline$validate_and_plot(
  validation_prot_df = prot_val,
  validation_cat_df  = cat_val,
  category1 = "SRS1",
  category2 = "non-SRS1"
)
```

```{r save_baseline}
baseline$save_plots_to_pdf(file.path(data_path, "Sepsis_Baseline_R.pdf"))
```

# 6. ADAPT-MS Classifier

```{r adaptms}
adaptms <- AdaptmsClassifierDF$new(
  prot_df   = prot_disc,
  cat_df    = cat_disc,
  gene_dict = gene_dict,
  between   = "SRS"
)

adaptms$classify_and_plot(
  category1 = "SRS1",
  category2 = "non-SRS1",
  n_runs = model_runs,
  topn_features = 50
)
```

## 6.1 ADAPT-MS Validation

```{r adaptms_val}
adaptms$classify_dataframe(
  validation_df     = prot_val,
  validation_cat_df = cat_val
)

adaptms$plot_validation_roc(
  category1 = "SRS1",
  category2 = "non-SRS1"
)
```

```{r save_adaptms}
adaptms$save_plots_to_pdf(file.path(data_path, "Sepsis_ADAPTMS_R.pdf"))
```

# 7. XGBoost with Zero-Fill Validation

```{r xgbfill}
xgbfill <- XGBRFClassifierDF$new(
  prot_df   = prot_disc,
  cat_df    = cat_disc,
  gene_dict = gene_dict,
  between   = "SRS"
)

xgbfill$classify_and_plot(
  category1 = "SRS1",
  category2 = "non-SRS1",
  n_runs = model_runs
)
```

## 7.1 XGBfill Validation

```{r xgbfill_val}
xgbfill$classify_dataframe(
  validation_df     = prot_val,
  validation_cat_df = cat_val,
  fill_na_strategy  = "zero"
)

xgbfill$plot_validation_roc(
  category1 = "SRS1",
  category2 = "non-SRS1"
)
```

```{r save_xgbfill}
xgbfill$save_plots_to_pdf(file.path(data_path, "Sepsis_XGBfill_R.pdf"))
```

# 8. Session Info

```{r session_info}
sessionInfo()
```
